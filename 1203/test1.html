<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.11/jquery.csv.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="test1.js"></script>
  <link rel="stylesheet" href="test1.css">
</head>
<div class="fixed-line-container">
    <span>greenhouse gas emissions</span>
</div>
<body>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  
  <h1>In 2000, the country emitted the most total greenhouse gases.</h1>
  <span></span>

  <a href="pages/index.html" style="color: blue;">visualizing CO2</a>
  <div id="map"></div>
  <div id="cheakbox">
    <div class="test">CHOICE YEAR</div>
    <div class="checkbox-container">
      <input type="checkbox" value="1990-1991" data-year="1990-1991" id="checkbox1">
      <label for="checkbox1">'90-'91</label>
    </div>
  
    <div class="checkbox-container">
      <input type="checkbox" value="1992-1993" data-year="1992-1993" id="checkbox2">
      <label for="checkbox2">'92-'93</label>
    </div>

    <div class="checkbox-container">
      <input type="checkbox" value="1994-1995" data-year="1994-1995" id="checkbox3">
      <label for="checkbox3">'94-'95</label>
    </div>

    <div class="checkbox-container">
      <input type="checkbox" value="1996-1997" data-year="1996-1997" id="checkbox4">
      <label for="checkbox4">'96-'97</label>
    </div>

    <div class="checkbox-container">
      <div class="test">Choosing Country</div>
      <select id="mySelect">
      </select>
    </div>
    
  </div>

  <div id="cheakbox1">
    <div class="checkbox-container">
      <input type="checkbox" value="1998-1999" data-year="1998-1999" id="checkbox5">
      <label for="checkbox5">'98-'99</label>
    </div>
    <div class="checkbox-container">
      <input type="checkbox" value="2000-2001" data-year="2000-2001" id="checkbox6">
      <label for="checkbox6">'00-'01</label>
    </div>
    <div class="checkbox-container">
      <input type="checkbox" value="2002-2003" data-year="2002-2003" id="checkbox7">
      <label for="checkbox7">'02-'03</label>
    </div>
    <div class="checkbox-container">
      <input type="checkbox" value="2004-2005" data-year="2004-2005" id="checkbox8">
      <label for="checkbox8">'04-'05</label>
    </div>

    <div class="checkbox-container">
      <div class="test">Choosing gases</div>
      <select id="mySelect1">
      </select>
    </div>
  </div>


  <table id="csvTable">
    <thead>
      <tr id="headerRow"></tr>
    </thead>
    <tbody id="dataRows"></tbody>
  </table>
  <script>

var lagend=d3.Legend;

// 读取CSV文件
var hale;

loadMapData();

// 调用getData函数，并将结果赋值给一个变量
getworld().then((world) => {
  console.log('Data received world:', world);
  var countries=(getcountries(world));
  console.log('Data received contries:', countries);

  const width = 2000;
  const marginTop = 46;
  const height = width / 2 + marginTop;
  // Fit the projection.
  // 使用D3.js库中的d3.geoEqualEarth方法创建了一个等地面投影（Equal Earth Projection）的地理投影器（projection）。
  // 投影器的属性被设置为适应给定的范围。[[2, marginTop + 2], [width - 2, height]]表示投影器的范围，
  // 包含一个矩形区域的两个对角坐标点。
  const projection = d3.geoEqualEarth().fitExtent([[2, marginTop + 2], [width - 2, height]], {type: "Sphere"});

  // 使用D3.js库中的d3.geoPath方法创建了一个地理路径生成器（path generator），
  // 并将之前创建的地理投影器（projection）作为参数传递给生成器。生成器根据提供的地理投影器将地理坐标转换为屏幕坐标。
  const path = d3.geoPath(projection);
  // Index the values and create the color scale.
  // const valuemap = new Map(hale.map(d => [d.country, d.hale]));
  // const valuemap = new Map(hale.map(d => [d.name, d.hale]));
  // max:1,226,702.22 
  // min:104.13

  // 使用D3.js库中的d3.scaleQuantize方法创建了一个量化比例尺.量化比例尺用于将连续的数值范围映射到离散的颜色值。
  // [1, 10]表示输入的数值范围为1到10.d3.schemeGreens[9]表示要使用的颜色方案，
  // 这里选择了D3.js库中提供的"Greens"方案的9个离散颜色值。
  const color = d3.scaleQuantize([1, 10], d3.schemeGreens[9]);

  // hale.map(d => [d.name, d.hale])通过遍历hale数组的每个元素，创建一个新的数组，其中每个元素都是一个
  // 由name和hale属性组成的数组。这样就生成了一组键值对，其中键是d.name，值是d.hale。
  // 通过new Map()构造函数，使用这组键值对数组来创建一个新的Map对象。
  const valuemap = new Map(hale.map(d => [d.name, d.hale]));
// const color = d3.scaleSequential(d3.extent(valuemap.values()), d3.interpolateYlGnBu);
  // Create the SVG container.
  const svg  = d3.select("#map")
      .append("svg")
      .attr("width", "100%")
      .attr("height", height)
      .attr("viewBox", [0, 0, width, height]) // 设置svg元素的视图框（viewBox），
      // 其中[0, 0, width, height]表示视图框的左上角点坐标为(0, 0)，宽度和高度与预定义的width和height相同。
      .attr("style", "max-width: 100%; height: auto;");
  // svg.append("g")
  //     .attr("transform", "translate(610,20)")
  //     .append(() => Legend(color, {title: "Unemployment rate (%)", width: 260}));
  svg.append("path")
    .datum({type: "Sphere"}) // 设置datum数据为一个对象，表示绘制球体。
    .attr("fill", "white") // 表示球体填充颜色为白色。
    .attr("stroke", "currentColor") // 设置stroke属性为currentColor，表示使用当前元素的颜色作为描边颜色。
    .attr("d", path); // 设置d属性为之前创建的地理路径生成器path，用于指定球体的路径数据。
  svg.append("g") // 在svg元素中添加一个g元素，用于容纳一组path元素。
    .selectAll("path") // 选择所有的path元素。
    .data(countries.features) // 绑定数据，将countries.features数组中的每个元素与选中的path元素关联起来。
    .join("path") // 将绑定的数据应用到选择集中的元素上，如果绑定的数据比选择集中的元素多，
    // 则创建新的path元素；如果绑定的数据比选择集中的元素少，则移除多余的元素。
    // .attr("fill", d => color(valuemap.get(d.properties.name)))
    .attr("fill", d => color(valuemap.get(d.properties.name))) // 根据每个元素的属性值，
    // 使用valuemap和color比例尺来确定fill属性的值，从而设置path元素的填充颜色。
    // .attr("fill",d => valuemap.get(d.properties.name))
    // .attr("fill","blue")
    .attr("d", path) // 设置d属性为之前创建的地理路径生成器path，用于指定路径数据。
    .append("title") // 在每个path元素中添加一个title元素。
      .text(d => `${d.properties.name}\n${valuemap.get(d.properties.name)}`); // 设置title元素的文本内容，
      // 其中包含d.properties.name和对应的valuemap值，用于显示元素的名称和相关信息。
});


$(document).ready(function() {
        var csvData;
  $.ajax({
    type: "GET",
    url: "data.csv",
    dataType: "text",
    success: function(data) {
      csvData = $.csv.toArrays(data);

       
      

      if (csvData.length > 0) {
        var countries = []; // 存储所有的 Country 值，创建下拉框

        // 提取所有的 Country 值
        for (var i = 1; i < csvData.length; i++) {
          var country = csvData[i][1]; // Country 属性所在的列，假设为第一列
          if (countries.indexOf(country) === -1) {
            countries.push(country);
          }
        }

        // 创建下拉框
        var dropdown = $("#mySelect");

        // 添加选项
        for (var j = 0; j < countries.length; j++) {
          dropdown.append($("<option></option>").attr("value", countries[j]).text(countries[j]));
        }


        var gases = []; // 存储所有的 gases 值,创建新的下拉框

        // 提取所有的 gases 值
        for (var i = 1; i < csvData.length; i++) {
          var gas = csvData[i][3]; // gases 属性所在的列，假设为第一列
          if (gases.indexOf(gas) === -1) {
            gases.push(gas);
          }
        }

        // 创建下拉框
        var dropdown1 = $("#mySelect1");

        // 添加选项
        for (var j = 0; j < gases.length; j++) {
          dropdown1.append($("<option></option>").attr("value", gases[j]).text(gases[j]));
        }


        var headerRow = csvData[0];
        var tableHeaders = "";
        var tableRows = "";
        var rowLimit = 1000; // 设定行数限制

        // 构建表头
        $.each(headerRow, function(index, value) {
          tableHeaders += "<th>" + value + "</th>";
        });
        $("#headerRow").append(tableHeaders);

        // 构建数据行
        for (var i = 1; i < csvData.length && i <= rowLimit; i++) {
          var rowData = csvData[i];
          var tableCells = "";

          $.each(rowData, function(index, value) {
            tableCells += "<td>" + value + "</td>";
          });

          tableRows += "<tr>" + tableCells + "</tr>";
        }
        $("#dataRows").append(tableRows);

        // 添加排序功能
        $("th").click(function() {
          var columnIndex = $(this).index();
          var sortOrder = $(this).data("sort");

          // 切换排序顺序
          if (sortOrder === "asc") {
            $(this).data("sort", "desc");
            csvData.sort(function(a, b) {
              return b[columnIndex].localeCompare(a[columnIndex]);
            });
          } else {
            $(this).data("sort", "asc");
            csvData.sort(function(a, b) {
              return a[columnIndex].localeCompare(b[columnIndex]);
            });
          }

          // 更新表格内容
          tableRows = "";
          for (var i = 1; i < csvData.length && i <= rowLimit; i++) {
            var rowData = csvData[i];
            var tableCells = "";

            $.each(rowData, function(index, value) {
              tableCells += "<td>" + value + "</td>";
            });

            tableRows += "<tr>" + tableCells + "</tr>";
          }
          $("#dataRows").html(tableRows);

          
        });
      }
    }
  });

  // 监听多选框和下拉框的变化事件
  $(".checkbox-container input[type='checkbox'], #mySelect, #mySelect1").change(function() {
    updateTable(csvData);
  });
});
</script>
</body>
<footer>
    &copy; 2023 环境主题页面. All rights reserved.
</footer>
</html>